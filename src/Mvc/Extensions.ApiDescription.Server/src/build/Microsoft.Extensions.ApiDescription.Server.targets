<?xml version="1.0" encoding="utf-8" standalone="no"?>
<Project>
  <PropertyGroup>
    <_OpenApiDocumentsCache>$(BaseIntermediateOutputPath)$(MSBuildProjectFile).OpenApiFiles.cache</_OpenApiDocumentsCache>
  </PropertyGroup>
  <ItemGroup Condition=" '$(OpenApiRetrieveDocuments)' == 'true' ">
    <ProjectCapability Include="OpenApiGetDocuments" />
  </ItemGroup>

  <Target Name="OpenApiGetDocuments" Returns="@(_OpenApiProjectDocuments)">
    <ReadLinesFromFile File="$(_OpenApiDocumentsCache)">
      <Output TaskParameter="Lines" ItemName="_OpenApiProjectDocuments" />
    </ReadLinesFromFile>
  </Target>

  <Target Name="RetrieveOpenApiDocuments" Condition=" '$(OpenApiRetrieveDocuments)' == 'true' ">
    <PropertyGroup>
      <_Command>dotnet "$(MSBuildThisFileDirectory)/../tools/dotnet-getdocument.dll" --assembly "$(TargetPath)"</_Command>
      <_Command>$(_Command) --file-list "$(_OpenApiDocumentsCache)" --framework "$(TargetFrameworkMoniker)"</_Command>
      <_Command>$(_Command) --output "$(OpenApiDocumentDirectory)" --project "$(MSBuildProjectName)"<_Command>
      <_Command Condition=" '$(ProjectAssetsFile)' != '' ">$(_Command) --assets-file "$(ProjectAssetsFile)"</_Command>
      <_Command Condition=" '$(PlatformTarget)' != '' ">$(_Command) --platform "$(PlatformTarget)"</_Command>
      <_Command Condition=" '$(PlatformTarget)' == '' AND '$(Platform)' != '' ">$(_Command) --platform "$(Platform)"</_Command>
      <_Command Condition=" '$(RuntimeIdentifier)' != '' ">$(_Command) --runtime "$(RuntimeIdentifier)"</_Command>
      <_Command>$(_Command) $(OpenApiGetDocumentOptions)</_Command>
    </PropertyGroup>

    <Message Importance="high" Text="%0ARetrieveOpenApiDocuments:" />
    <Message Importance="high" Text="  $(_Command)" />
    <Exec Command="$(_Command)" />
  </Target>

  <!-- Unless this is an inner build or default timing is disabled, tie document retrieval into the build. -->

  <Target Name="_RetrieveOpenApiDocuments"
      AfterTargets="Build"
      Condition=" '$(OpenApiRetrieveDocumentsAfterBuild)' == 'true' AND ('$(TargetFramework)' == '' OR '$(TargetFrameworks)' == '') "
      DependsOnTargets="RetrieveOpenApiDocuments" />
</Project>
